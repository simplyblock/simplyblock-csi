{{- if and .Values.storagenode.create .Values.storagenode.enableCpuTopology -}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: simplyblock-numa-resource-plugin
  namespace: kube-system

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: simplyblock-numa-resource-plugin-config
  namespace: kube-system
data:
  # Capacity per NUMA node (default: 100)
  # Higher values allow more pods to request the same NUMA node
  NUMA_CAPACITY: "100"

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: simplyblock-numa-resource-plugin
  namespace: kube-system
  labels:
    app: simplyblock-numa-resource-plugin
spec:
  selector:
    matchLabels:
      app: simplyblock-numa-resource-plugin
  template:
    metadata:
      labels:
        app: simplyblock-numa-resource-plugin
    spec:
      serviceAccountName: simplyblock-numa-resource-plugin
      priorityClassName: system-node-critical
      {{- $dsList := .Values.storagenode.daemonsets | default (list) -}}
      {{- if gt (len $dsList) 0 }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ (index $dsList 0).nodeSelector.key | quote }}
                operator: In
                values:
                {{- range $i, $ds := $dsList }}
                {{- if and $ds.nodeSelector $ds.nodeSelector.value }}
                - {{ $ds.nodeSelector.value | quote }}
                {{- end }}
                {{- end }}
      {{- end }}
      tolerations:
        # Run on all nodes including control plane
        - operator: Exists
          effect: NoSchedule
        - operator: Exists
          effect: NoExecute
      containers:
        - name: numa-plugin
          image: "{{ .Values.image.numaResource.repository }}:{{ .Values.image.numaResource.tag }}"
          imagePullPolicy: {{ .Values.image.numaResource.pullPolicy }}
          securityContext:
            privileged: false
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          envFrom:
            - configMapRef:
                name: simplyblock-numa-resource-plugin-config
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ls /var/lib/kubelet/device-plugins/numa-*.sock >/dev/null 2>&1"
            initialDelaySeconds: 10
            periodSeconds: 30
          volumeMounts:
            # Standard kubelet device-plugins directory
            - name: device-plugin-kubelet
              mountPath: /var/lib/kubelet/device-plugins
            # Read NUMA topology from /sys
            - name: sys
              mountPath: /sys
              readOnly: true
      volumes:
        - name: device-plugin-kubelet
          hostPath:
            path: /var/lib/kubelet/device-plugins
            type: DirectoryOrCreate
        - name: sys
          hostPath:
            path: /sys
            type: Directory
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

{{- end -}}
